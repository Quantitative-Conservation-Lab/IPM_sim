---
title: ''
output:
  word_document:
    reference_docx: mytemplate.docx
  pdf_document: default
---

To-do's

Figures/analysis/etc

*my understanding is that these are all done - just need to be pasted in to the final doc*

- posterior densities (amanda)
<!-- - life cycle/survey timing diagram (amelia) -->
- figure captions/printing (amanda)
<!-- - 3 dags (amelia) -->

Displaying results
- posterior densities
<!-- - table (true values, data included, posterior mean, 95% CI, mean bias, mean RMSE) -->



```{r include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, results = 'asis', fig.width = 4, fig.height = 3.5)
#for reference: https://rstudio.com/wp-content/uploads/2015/02/rmarkdown-cheatsheet.pdf

```

```{r load packages, results = 'hide'}

library(tidyr)
library(dplyr)
library(cowplot)
library(ggplot2)
library(coda)
library(captioner)
library(knitr)
library(reshape2)
library(here)

#functions to use for calling figures/tables
figs <- captioner(prefix = "Figure")
tbls <- captioner(prefix = "Table")
cols <- c("violetred4", "dodgerblue3", 'deepskyblue1', "#4aaaa5", "#a3d39c", "#f6b61c", "chocolate2", "red3")

#source a plot theme for figures
# source(here::here('scripts', 'PlotTheme.R'))

```


```{r figures - multiple chains, eval = F, results = 'hide', cache = F}

#true vals
truth <- readRDS(here::here('data', 'scenarios.Rdata')) 
colnames(truth) <- gsub(' ', '', colnames(truth))
true_vals <- truth %>%
  dplyr::select(ScenarioNumber, MRdetection, Abunddetection, AdultSurv, JuvSurv, Dailynestsurvival, Fec) %>%
  dplyr::rename(scenario = ScenarioNumber) %>%
  reshape2::melt(id.vars = c('scenario'), value.name = 'Truth') %>%
  transform(variable = factor(variable,
                              levels = c('JuvSurv', 'AdultSurv', 'Fec', 'Dailynestsurvival', 'MRdetection', 'Abunddetection'),
                              labels = c('Juvenile survival', 'Adult survival', 'Fecundity', 'Daily nest survival', 
                                         'MR detection', 'Survey detection'))) %>%
  transform(Data = ifelse(scenario < 6, 'All', 
                          ifelse(scenario < 11 & scenario > 5, 'Counts + Productivity', 'Counts + MR'))) %>%
  transform(Truth = ifelse(Data == 'Counts + Productivity' & variable == 'MR detection', NA, Truth))

# ~~~~~~~~~~~~~~~~~~~~~~~~~~ #

### assessing convergence

# test <-readRDS(file = here::here('data', paste0('out_3-1.Rdata')))[3500:4000,]


sc <- c(1:5, 11:15)
# sc <- c(1:5)
nsim <- 25
pars <- c('fec', 'lambdaf', 'mean.p', 'mean.phi[1]', 'mean.phi[2]', 'p.surv', 'phi.nest')

out_meds1 <- data.frame() #storage
for (s in sc) {
  for (i in 1:nsim) { 
chains <- as.mcmc.list(list(
  as.mcmc(readRDS(file = here::here('data', paste0('out', s, '_', i, '-', 1, '.Rdata')))[3500:4000,]), 
  as.mcmc(readRDS(file = here::here('data', paste0('out', s, '_', i, '-', 2, '.Rdata')))[3500:4000,]), 
  as.mcmc(readRDS(file = here::here('data', paste0('out', s, '_', i, '-', 3, '.Rdata')))[3500:4000,])))

max_rhat <- max(gelman.diag(chains[,pars[-6]], multivariate=F, autoburnin=F)$psrf[,1], na.rm = T)

## posterior medians
out_temp <- data.frame(t(c(summary(chains)$q[pars,"50%"], max_rhat, i, s)))
colnames(out_temp) <- c(names(summary(chains)$q[pars,"50%"]), 'max_rhat', 'sim', 'scenario')

out_meds1 <- rbind(out_meds1, out_temp)

  } #sims
} #scenarios

#scenarios without p.surv
sc <- c(6:10)
# sc <- c(6:9)

pars <- c('fec', 'lambdaf', 'mean.phi[1]', 'mean.phi[2]', 'p.surv', 'phi.nest')

out_meds2 <- data.frame() #storage
for (s in sc) {
  for (i in 1:nsim) { 
chains <- as.mcmc.list(list(
  as.mcmc(readRDS(file = here::here('data', paste0('out', s, '_', i, '-', 1, '.Rdata')))[3500:4000,]), 
  as.mcmc(readRDS(file = here::here('data', paste0('out', s, '_', i, '-', 2, '.Rdata')))[3500:4000,]), 
  as.mcmc(readRDS(file = here::here('data', paste0('out', s, '_', i, '-', 3, '.Rdata')))[3500:4000,])))

max_rhat <- max(gelman.diag(chains[,pars], multivariate=F, autoburnin=F)$psrf[,1], na.rm = T)

## posterior medians
out_temp <- data.frame(t(c(summary(chains)$q[pars,"50%"], max_rhat, i, s)))
colnames(out_temp) <- c(names(summary(chains)$q[pars,"50%"]), 'max_rhat', 'sim', 'scenario')

out_meds2 <- rbind(out_meds2, out_temp)

  } #sims
} #scenarios

out_meds <- bind_rows(out_meds1, out_meds2)

post_meds <- out_meds %>% 
  filter(max_rhat < 1.8) %>%
  dplyr::select(-c(max_rhat, lambdaf)) %>%
  reshape2::melt(id.vars = c('scenario', 'sim')) %>%
  filter(variable %in% c('mean.phi[1]', 'mean.phi[2]', 'fec', 'phi.nest', 'p.surv', 'mean.p')) %>%
  transform(variable = factor(variable,
                              levels = c('mean.phi[1]', 'mean.phi[2]', 'fec', 'phi.nest', 'mean.p', 'p.surv'),
                              labels = c('Juvenile survival', 'Adult survival', 'Fecundity', 'Daily nest survival', 
                                         'MR detection', 'Survey detection'))) %>%
  transform(Data = ifelse(scenario < 6, 'All', 
                          ifelse(scenario < 11 & scenario > 5, 'Counts + Productivity', 'Counts + MR')))

meds_plot <- ggplot(post_meds, aes(y = value, x = scenario, group = scenario)) +
  geom_boxplot(aes(color = Data)) +
  geom_point(size = 0.7, col = 'darkgrey') + 
  geom_point(data = true_vals, aes(y = Truth, x = scenario, group = scenario), col = 'darkred') +
  xlab('Scenario') + ylab('Posterior medians') +
  facet_wrap(~variable, scales = 'free_y', nrow = 3) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        legend.position = 'top') +
  scale_x_continuous(breaks = 1:15) +
  scale_color_manual(values = cols[c(2,3,5)])

#relative bias
bias_vals <- post_meds %>% 
  merge(true_vals %>% dplyr::select(scenario, variable, Truth), by = c('scenario', 'variable')) %>%
  transform(bias = value-Truth, rel_bias = (value-Truth)/Truth) 

bias_plot <- ggplot(bias_vals, aes(y = rel_bias, x = scenario, group = scenario)) +
  geom_boxplot(aes(color = Data)) +
  geom_point(size = 0.7, col = 'darkgrey') + 
  geom_hline(aes(yintercept = 0), linetype = 'dashed', col = 'darkred') +
  xlab('Scenario') + ylab('Relative bias') +
  facet_wrap(~variable, scales = 'free_y', nrow = 3) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        legend.position = 'top') +
  scale_x_continuous(breaks = 1:15) +
  scale_color_manual(values = cols[c(2,3,5)])

#rmse
rmse_vals <- post_meds %>% 
  merge(true_vals %>% dplyr::select(scenario, variable, Truth), by = c('scenario', 'variable')) %>%
  transform(rmse.temp = (value-Truth)^2) %>% #simulation level
  group_by(Data, scenario, variable) %>%
  dplyr::summarize(rmse = sqrt(mean(rmse.temp))) #scenario level

# rmse_plot <- ggplot(rmse_vals, aes(y = rmse, x = scenario, group = scenario)) +
#   geom_boxplot(aes(color = Data)) +
#   geom_point(size = 0.7, col = 'darkgrey') +
#   # geom_hline(aes(yintercept = 0), linetype = 'dashed', col = 'darkred') +
#   xlab('Scenario') + ylab('RMSE') +
#   facet_wrap(~variable, scales = 'free_y', nrow = 3) +
#   theme_classic() +
#   theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
#         legend.position = 'top') +
#   scale_x_continuous(breaks = 1:15) +
#   scale_color_manual(values = cols[c(2,3,5)])
# 
# figs("rmse_plot", caption = "Figure of RMSE per scenario.")


```

```{r summary table, eval = F}

posterior_summary <- post_meds %>%
  group_by(scenario, variable) %>%
  dplyr::summarize(post_med = round(median(value), 2)) %>%
  dcast(scenario ~ variable, value.var = 'post_med')

bias_summary <- bias_vals %>%
  group_by(scenario, variable) %>%
  dplyr::summarize(mean_bias = round(mean(rel_bias), 2)) %>%
  dcast(scenario ~ variable, value.var = 'mean_bias')
write.csv(bias_summary, file = here::here('results', 'bias_summary.csv'))

rmse_summary <- rmse_vals %>%
  group_by(scenario, variable) %>%
  dplyr::summarize(mean_rmse = round(mean(rmse), 2)) %>%
  dcast(scenario ~ variable, value.var = 'mean_rmse')
write.csv(rmse_summary, file = here::here('results', 'rmse_summary.csv'))

summary_tab <- bias_summary %>%
  merge(rmse_summary, by = 'scenario', suffixes = c('.bias', '.rmse')) %>%
  merge(true_vals %>% dplyr::select(scenario, Data) %>% distinct(), by = 'scenario') %>%
  dplyr::select(Data, scenario, JuvSurv.bias, JuvSurv.rmse, AdultSurv.bias, AdultSurv.rmse, 
                Fec.bias, Fec.rmse, Dailynestsurvival.bias, Dailynestsurvival.rmse, 
                Abunddetection.bias, Abunddetection.rmse, MRdetection.bias, MRdetection.rmse)

write.csv(summary_tab, file = here::here('results', 'summary_table.csv'))

```


**Title**  

Ideas: 
- Performance of integrated population models across varying data landscapes *happy with this one for now because it's consistent with our presentation*
- When and how far can we push the integrated population model framework? Estimating demographic parameters under variable data landscapes  
- Pushing the limits: examining minimal data requirements for estimating demographic parameters in an integrated population model framework  

Abby Bratt, Caroline Cappello, Amelia DuVall, Hannah Sipe, Amanda Warlick


**Introduction**  

Understanding the processes that control population dynamics in wild populations is a critical component of conservation and management but is frequently limited by missing demographic information, uncertainty, and temporally or spatially misaligned datasets (Schaub & Abadi 2011, Zipkin & Saunders 2017). Integrated population models (IPMs; Besbeas et al. 2002, Brooks et al. 2004) are an increasingly popular tool in ecology that can help overcome these limitations by combining disparate datasets in a single, unified analysis (Schaub & Abadi 2011). This approach can provide several advantages, such as improved precision (Schaub et al. 2007, Tavecchia 2009, Abadi et al. 2010) and the estimation of parameters that would otherwise be unidentifiable (Besbeas 2005, Schaub et al. 2007, Veran & Lebreton 2008), which is often the case for key demographic rates such as recruitment or immigration. These advances have practical benefits for resource managers that must make decisions based on limited available information. As IPMs become more widely used, however, it is critical that they are robustly evaluated. 

Since the introduction of IPMs to ecology in the early 2000s and following the work of Besbeas and colleagues with passerines (Besbeas et al. 2002, 2005), the common approach has been to estimate parameters by combining mark-recapture and abundance data into a joint likelihood. Researchers have has since expanded the use of IPMs to include a variety of taxa (e.g., bats *Rhinolophus ferrumequinum* (Schaub et al. 2007); Svalbard reindeer *Rangifer tarandus platyrhynchus* (Lee et al. 2015), Antarctic toothfish *Dissostichus mawsoni* (Mormede et al. 2019), wild boar *Sus scrofa* (Gamelon et al. 2019)). Applications have also been developed to estimate transition probabilities within multi-state and multi-site systems (McCrea et al. 2012), evaluate management efficacy and trade-offs (Cruz et al. 2018), and to estimate the effects of environmental processes and stochasticity on demography (Oppel et al. 2014, Woodworth et al. 2017). This proliferation of integrated population modeling has occurred despite a relatively poor understanding of how to assess goodness of fit for the joint likelihood. Additionally, the limitations of the IPM framework are still underexplored, particularly in situations where available data are sparse, of poor quality, or when data to inform specific parameters are entirely absent (i.e., most field studies may have count surveys, but not all have data informing both recruitment and survival). 

Data simulation studies provide an avenue for robust evaluations of the IPM framework, but few such studies exist. Those that have used data simulation largely focus on (1) proof of concept (i.e., improved precision and reduced bias of parameter estimation) or (2) violation of assumptions within the subcomponent models (i.e., marker-induced bias or heterogeneity in survival) or the joint likelihood (i.e., dataset independence). In the former, IPMs generally have led to improved precision and unbiased estimates of parameters that would otherwise be unidentifiable using traditional approaches (McCrea et al. 2010, Chandler & Clark 2014, Schaub & Fletcher 2015, Bled et al. 2017, Ahrestani et al. 2017, Bowler et al. 2019), though not always depending on sample sizes, dominance of one dataset over another, or the likelihood structures (citation). In examining the effects of violating model assumptions on bias and precision, results have been mixed and again largely depend on sample sizes, effect sizes, parameterization, and the dominance of given datasets. In some cases, dependence across datasets has been shown to result in biased estimates or at least overly optimistic estimates of uncertainty (Goodman et al. 2004, Besbeas et al. 2009) while in others the effects on bias and precision are minimal (Abadi et al. 2010, Schaub & Fletcher 2015, Weegman et al. 2020). Riecke et al. (2019) found that estimates for previously unidentifiable parameters were highly sensitive to violations of mark-recapture model assumptions (i.e., marker-induced bias and survival heterogeneity). 

These studies motivate the further examination of the strengths and weaknesses IPMs across a range of model structures and data landscapes, particularly when certain demographic rates are not directly informed by data or when a data source is sparse, biased, or highly uncertain. This type of analysis has been conducted for species distribution models in a few cases (Farr et al. 2020, Simmonds et al. 2020), but has not yet been rigorously explored for an IPM. Through a simulation analysis, we aim to gain insights about this statistical framework, particularly as applied to a passerine bird life history. We assume all model assumptions are met and compare parameter estimation for a traditional IPM with data informing abundance (count data), survival (mark-recapture data), and reproductive output (nest monitoring data) to situations when either of the latter two datasets are omitted. In each of these three cases, we also examine parameter estimation when juvenile survival varies and under situations with low detection to reflect a higher degree of uncertainty. In future iterations of this analysis, we also plan to compare model performance in situations when datasets informing survival and reproduction are not only uncertain (low detection probability) but also sparse (reduced survey frequency), and the effects of having lower or variable adult survival and reproductive output.
 
Through this study, we will identify scenarios where IPMs may not lead to improved precision or return unbiased estimates of parameters that would otherwise be unidentifiable when certain datasets are excluded. In doing so, we will refine our understanding of the mechanisms underlying IPMs and can better identify when they may serve as a useful tool or might not be necessary or warrant the collection of additional data. Improving our understanding of the strengths and weaknesses of the IPM framework can provide helpful insights for the design and implementation of field survey programs so as to most efficiently make use of limited resources to inform management efforts aimed at monitoring or recovering species that are deemed ecosystem indicators or depleted and in need of conservation intervention.

**Methods**   

*Data simulation: life history*  
We simulated data for an avian species assuming life history stages and traits of a typical passerine. Our simulated hypothetical species has two age-classes: 1 year-old juveniles and adults (individuals older than 1 year). Each age class has a unique survival rate ($\phi_1$, $\phi_{ad}$) and adults produce new chicks at fecundity rate *f*, and those chicks survive to be juveniles at rate $\phi_1$. Current juveniles will also breed the following year to produce surviving chicks at rate $f \times \phi_1$ (Fig 1). We assume an annual breeding cycle, with females nesting once per year. The period from nest initiation to fledging is 30 days regardless of clutch size. We also assume that survival and fecundity are constant across years and individuals. 

As is often the convention, we use a female-only model because we assume that the population dynamics of our species are driven largely by female abundance and demography. All demographic rates are assumed constant over a 10-year study period. The population is quite small and the survey extends across the entire range, therefore we assume no immigration or emigration.

*insert life cycle diagram here - figure 1*

*Model framework and assumptions*  

*Count model*  
We simulated data such that the population is surveyed annually in a 10-year pre-breeding census. Count surveys are conducted three times per year in quick succession such that we assume the population is closed between secondary sampling periods. We use an N-mixture model (citations) to estimate annual abundance from these repeated counts, where we assume no individual is double counted and that individual detections are independent and occur with equal probability. The underlying state process represents the latent variables of stage-specific abundance at each occasion for 1 year-olds, $N_{1}$ is modeled as:

$$N_{1, t+1} \sim \text{Poisson}(N_{1,t}\times \phi_{1}\times \frac{f}{2} + N_{ad,t}\times \phi_{ad}\times \frac{f}{2})$$  
where the number of juveniles in the next year, $N_{1,t+1}$, is estimated using a Poisson distribution with probability based on the sum of stage-specific individuals at time $t$ that survive ($\phi_{1,ad}$) and reproduce ($f$). 

A binomial distribution is used to estimate the number of adults in the next year, $N_{ad, t+1}$ based on the stage-specific survival and abundance in the previous occasion (i.e. $t$):
$$N_{ad,t+1} \sim \text{Binomial}(N_{1,t} + N_{ad,t}, \phi_{ad,t})$$  


The observation process model for the count data in each year $t$ is modeled using a binomial distribution: 

$$y_t \sim \text{Binomial} (N_{tot, t}, p_s)$$
with $N_{tot,t}=N_{1,t}+N_{ad,t}$. The observed counts in each year, $y_t$, are assumed to be binomially distributed with a sample size of $N_{tot,t}$ and probability of detection $p_s$. The probability of detection for the observation process, $p_s$, of the count model is assumed constant across years and surveys. The survey detection probability was modeled on the probability scale using a uniform prior, $p_{s} \sim \text{Uniform}(0,1)$.

The likelihood of the N-mixture abundance model is the product of the state and observation process models: $L_{Abundance}(\text{y}| ~N_1, ~N_{ad}, ~{p_s}, \phi_1,~\phi_{ad}, f)$

*Nest success productivity model*   

In this simulation, nests are monitored according to the procedures described in Martin and Geupel (1993), where adults are observed for behavioral clues that indicate nesting behavior and followed until a nest is found. After locating a nest, it is revisited every 2-3 days to check its status until it either fledges or fails. We assume no state uncertainty in our nest observations, that nests can be correctly aged when first found, and that monitored nests are independent and representative of the population. We assume the daily survival probability is uniform across nest stages (*i.e.*, laying, incubating, nestlings). We estimate daily nest survival to obtain unbiased estimates for the probability of nest success (*i.e.*, at least 1 chick fledges): We use a Poisson model to estimate the number of chicks fledged conditional on a nest being successful.

$$\text{Fledged}_t \sim \text{Poisson}(\lambda_{\text{fledglings}}) $$
The fecundity rate, *f*, is derived from the rate at which chicks fledge,
$$f=\frac{1}{2}\times\lambda_{\text{fledglings}}\times\phi_{n}^{30}$$
where $\phi_{n}$ is the nest survival probability and we assume that the maximum nest age, the number of days the nest was active, is 30. 
The observation process for the daily nest surveys is modeled using a Bernoulli distribution, based on daily nest survival probabilities and the state of the nest during the previous survey occasion:

$$\text{NestStatus}_{n,d}\sim\text{Bernoulli}(\phi_{n}\times\text{NestStatus}_{n,d-1})$$
where $\text{NestStatus}_{n,d}$ is the status of nest $n$ at survey occasion $d$, $\phi_{n}$ is the nest surivial probability, and $\text{NestStatus}_{n,d-1}$ is the state of nest $n$ at the previous survey occasion $d-1$. 

The likelihood of the nest success productivity model is $L_{Productivity}(\text{NestStatus}, \text{Fledged} | ~\phi_{n}, ~\lambda_{\text{fledglings}})$

*Mark-resight model*  
In this simulation study, juveniles and adults are marked just prior to the end of the breeding season with a unique combination of colored leg bands such that they can be individually identified over the course of their lives. 
Marked individuals are resighted during marking efforts in future years. To estimate stage-specific survival based on the individual encounter histories, we use a Cormack-Jolly-Seber (citation) model where we assume that marks are not lost or misread and that each marked individual has independent and identical survival and detection probabilities across occasions. The ecological state process *z* describes the probability that individual *i* at time *t* is alive or dead, namely:  

$$ z_{i,t}|z_{i,t-1} \sim \text{Bernoulli}(z_{i,t-1}\times \phi_{ad}) $$


where the state at time *t* is modeled with a Bernoulli distribution based on the state at the previous occasion and adult survival probability $\phi_{ad}$. Similarly, the observation process model

$$ CH_{i,t}|z_{i,t} \sim  \text{Bernoulli}(z_{i,t}\times p_{mr})$$
  
describes capture history observations *CH* using a Bernouli distribution based on the state of the individual in the current occasion and detection probability $p_{mr}$. Mean survival and detection probabilities are modeled on the probability scale using uniform priors, $\phi_{ad} \sim \text{Uniform}(0,1)$ and $p_{mr} \sim \text{Uniform}(0,1)$, respectively. The likelihood of the mark-resight model estimating the adult survival probability: $L_{Survival}(\text{y}|\text{z}, ~\phi_{ad}, ~p_{mr})$

*insert figure for observation timeline - figure 2*

*Integrated population model*  
To estimate abundance of the overall population $N_{tot}$ at each time *t*, the parameter estimates from the productivity and mark-resight models are combined with the stage-specific abundance estimated using the N-mixture model in a stochastic leslie population matrix model.

<!-- From amanda: help: not sure if we need something like this since we have the equations above? aeb - we can use begin{align} if we want and put $~ or &= where we want things to be centered around, but I think this is good enough for now-->
<!-- $$ \left[\begin{array} -->
<!-- {l} -->
<!-- N_{1,t+1} \sim \text{Binomial}(N_{1,t},~S_{1,t}) \\ -->
<!-- N_{ad,t+1} \sim \text{Binomial}(N_{ad,t},~S_{ad,t}) \\ -->
<!-- N_{Tot, t+1} = N_{1,t} + N_{ad,t} -->
<!-- \end{array}\right]  -->
<!-- $$  -->

The joint likelihood for the integrated population model is the product of the likelihoods for the three subcomponent models. In instances when one dataset is removed, noninformative priors are used in place of the data to inform each of the relevant parameters. 

[IPM joint likelihood equation] *is this how we want this?*
The overall likelihood for this hierarchical state-space model can be described as the product of the state and observation process models:
$$L_{IPM}(\text{y}, ~CH, ~\text{NestStatus}, ~\text{Fledged}|~N_{1},~N_{ad}, ~\phi_1, ~\phi_{ad}, ~f, ~p_{mr}, ~p_s, ~\lambda_{\text{fledglings}}, ~\phi_n) \ = $$
$$L_{Abundance}(\text{y}| ~N_1, ~N_{ad}, ~{p_s},~\phi_{ad}, ~f)\ \times$$
$$L_{Productivity}(\text{NestStatus}, ~\text{Fledged} | ~\phi_{n}, ~\lambda_{\text{fledglings}})\ \times$$
$$L_{Survival}(\text{y}|~\text{z}, ~\phi_{ad}, ~p_{mr})$$


*Simulation scenarios*  
We developed three versions of an IPM: 1) a "full" IPM that incorporates all three datasets (counts, productivity, mark-resight); 2) an IPM with the counts and productivity datasets only (excludes mark-resight dataset); and, 3) an IPM with the counts and mark-resight datasets only (excludes the productivity dataset) (Figure 3). There are numerous scenarios we could run to vary detection and survival probabilities for each IPM version and test our objectives. We opted to run a select number of scenarios to provide preliminary findings to inform future work. For each version of the IPM, we ran 5 scenarios, for a total of 15 scenarios (Table for scenarios). Within each scenario, we varied the following parameters: mark-resight probability (0.3, 0.5, 0.8), count detection probability (0.3, 0.5, 0.85), and juvenile survival (0.3, 0.4, 0.5). The remaining parameters were kept constant for all scenarios: daily nest survival (0.975), mean clutch size (2.5), max nest age (30), initial age distribution (1000 juveniles, 1000 adults), and adult survival (0.77). For demographic parameters, we chose to vary juvenile survival because it is a hidden parameter, and these various values result in 5% annual decline, a stable population size, and 5% annual growth, respectively. 

*need a table here - table 1 for true values, table 2 for varied params*

*also have the three dags next to each other - figure 3*

<!-- amelia - maybe easiest to create table in word doc when we also add figures? -->

<!-- amelia - I think these are all old notes? -->
<!-- Metrics to monitor   -->
<!-- CV (precision)   -->
<!-- RMSE (accuracy)   -->
<!-- Relative bias   -->

<!-- Vary data quantity/combinations and demographic rates   -->
<!-- Low MR detection vs high   -->
<!-- Low daily nest survival vs high   -->
<!-- Low abund detection vs high   -->

<!-- Best scenario, using all three datasets   -->
<!-- Potential add-on: vary life history traits:   -->
<!-- Survival: 0.3 vs. 0.8   -->
<!-- Fecundity: 0.3 vs. 0.5   -->
<!-- Remove nest monitoring entirely - use other two datasets (MR and counts)   -->
<!-- Model adjustments: informed priors?    -->
<!-- Sensitivity to priors?   -->
<!-- Remove MR data entirely - use other two datasets (nest monitoring and counts)   -->
<!-- Model adjustments: informed priors?   -->
<!-- Sensitivity to priors?    -->
<!-- Poorer quality MR   -->
<!-- Quantity: decrease N (20 individuals vs. 100 resights per year)   -->
<!-- Quality: decrease p (0.1, 0.5, 0.8) or annual surveys (5 vs. 10)   -->

*Estimation and diagnostics*   
<!-- amelia - just a quick draft, but is this right? AEB checked - made one small fix -->
Models were ran in NIMBLE using program R (NIMBLE 2020). We ran 45,000 iterations with the first 35,000 as a burn-in. We thinned samples to reduce autocorrelation and retained every 10th sample, for a total of 1,000 samples. Model convergence was assessed visually using trace plots and the Brooks-Gelman-Rubin statistic (Rhat). We examined model performance using relative bias and root mean square error (RMSE).

**Results**  
-something about lack of convergence?

- figures here
- *posterior medians - figure 4*
- *relative bias - figure 5*
- *rmse table - table 2*

*Full model*
Fitting the 'full' IPM model, including all simulated data types (counts, productivity, and mark-resight), generally produced parameter estimates close to the true value. The median model parameter estimates for $\phi_1$, $\phi_ad$, $f$, $\phi_n$, and $\p_{mr}$ across the 25 simulated data sets and under scenarios 1-5 resulted in estimates where the true parameter values are contained within $50%$ of the estimates. The model parameter estimates for the survey detection probability, $p_s$, were returned under scenarios where $p_s$ was $0.85$ (i.e. scenarios 1 and 2), but with greater uncertainty in the model estimates for scenarios 3,4,5 where the true value of $p_s$ was $0.3$ or $0.5$ (Figure 4). Relative bias under scenarios $1-5$ was generally low (less than $|0.1|$), with the exection of $p_s$ with high bias resulting in the low detection scenarios 3,4,5 where the model was not able to recover this parameter (Figure 5). RMSE for the full model was also generally low (less than $|0.1|$), with the exception of $\phi_1$ and $p_s$. The RMSE for $\phi_1$ was high for scenarios 3, which the RMSE for $p_s$ was high for scenarios 3,4,5 (Table 3). 

*Counts + Productivity*
The IPM fit with data only from count and productivity datasets (excluding mark-resight) provided median estimates of $\phi_n$ and $f$ that were close to truth under all scenarios (6-10). The median estimates for $\phi_1$ and $\phi_{ad}$ showed high variation in the model estimates for all scenarios and was unable to capture the true parameter values for scenarios 9 and 10 for both parameters. The survey detection probability median model estimates for scenarios 6,7,and 10 resulted in medians covering the true parameter estimates, but under scenarios 8 and 9 the model estimates over and underestimated the true parameter value, respectively (Figure 4). The relative bias for $\phi_1$ under scenarios 7,9,and 10 was high (greater than $|0.1|$), the relative bias for $\phi_ad$ under scenario 9 was also high. The relative bias for $p_s$ was high under scenarios 8 and 9 (Figure 5). The RMSE of the model estimates for $\phi_n$ and $f$ under scenarios 6-10 was close to 0. The RMSE for $\phi_1$ was high (greater than 0.1) for all scenarios (6-10), the RMSE for $\phi_{ad}$ was high for scenarios 6,7,9,and 10. The RMSE for $p_s$ was high for scenarios 8,9,and 10 (Table 3). 

*Counts + Mark-resight*
The IPM fit with data only from count and mark-resight datasets (excluding productivity data) resulted in median estimates of $\phi_{ad}$ and $p_{mr}$ that were close to truth for scenarios 11-15. The model excluding the productivity data resulted in medians that underestimated $f$, $\phi_ad$, and $\phi_1$ under all scenarios. The model was able to capture the true value of $p_{s}$ under scenarios 11, 12, 13, and 15 (Figure 4). The relative bias and RMSE for $\phi_1$ and $f$ were high. Whereas the relative bias and RMSE for all other parameters in scenarios 11-15 was low (less than |0.1|; Figure 5). 

**Discussion**  

This simulation analysis aims to explore the benefits and weaknesses of data integration for population models across varying levels of data quality (degree of uncertainty) and quantity (sample size, number of available datasets) for a typical passerine bird species. In essence, one of the main goals of the study was to examine when and to what extent and under what circumstances developing IPMs is worth the potential additional resources needed for data collection. Or, similarly, when this type of data integration framework can facilitate the estimation of parameters not directly informed by available data. Our initial results reaffirm the benefits of data integration for avian population modeling and highlight avenues of future investigation.

In our example of a typical passerine life history, the full IPM was the only data landscape in which parameters were successfully returned with relatively little to no bias. In this case, we can also see the importance of integrating all three datasets for the estimation of juvenile survival, which is not directly informed by any of the datasets. Even in the full IPM, however, we do see increased bias and decreased accuracy (as measured by higher RMSE) in survival (particularly juvenile) at low detection rates that is not improved upon when the survival rate is higher.  This suggests that detection probability is a strong determinant in parameter uncertainty. An important future scenario to examine under this full data landscape is whether that uncertainty could be overcome by increasing sample sizes and/or survey frequency.  

When examining model performance across the other reduced data landscapes, similar patterns arose when removing either mark-resight or productivity datasets. With only two datasets, bias increased and accuracy was reduced only for parameters directly informed by the dataset that was omitted, and this deterioration in model performance was much greater than from decreased detection probability in the full IPM. This pattern, if explored further, will start to reveal some of the trade-offs that are most interesting to more fully investigate using this framework. Specifically, it will be helpful to examine to what extent sample size would have to increase and uncertainty would have to be reduced in order to estimate the implicit parameters with a similar degree of accuracy and precision as with the IPM. And, when aiming to improve data quality and quantity, whether it can be accomplished more readily by increasing sample sizes and/or detection probability in mark-resight data versus productivity data. In other words, for our passerine, if, when, and to what extent does one dataset dominate another in terms of estimating abundance? 

With the progression of these analyses, our aim is to additionally understand how some of these trade-offs within an IPM framework might vary for other life histories (e.g., additional life stages) and survey features. Here we assume that all datasets are independent and that mark-recapture model assumptions hold, but it would be possible to explore violations of any of these. We are also interested in examining the ability of our IPM to detect a trend in demographic rates or abundance across the three data landscapes or in the face of unmodeled heterogeneity. 

Most research applications using an IPM framework cite the benefits of improved parameter estimation, including reduced bias and the ability to estimate implicit parameters, though not all authors can or choose to confirm this through data simulation or compare their IPM estimates with those from traditional modeling frameworks. It is likely that the benefits of IPMs are fairly variable and context-specific, meaning that the degree to which IPMs improve parameter estimation depend on life history, model assumptions, sample sizes, parameter uncertainty, and likelihood structure. This type of study can enhance our growing understanding of IPM performance when datasets may be sparse, biased, or both. Depending on the goal of a given monitoring or conservation and management program, it can be helpful to understand how biases in existing data affect our ability to produce accurate estimates of abundance and trends, and how it might or might not be possible to overcome sparseness or bias by collecting additional data. This information can be key to designing and implementing monitoring surveys for avian populations.


\newpage


**Literature cited**  

Abadi, F., Gimenez, O., Arlettaz, R., Schaub, M., 2010a. An assessment of integrated population models: bias, accuracy, and violation of the assumption of independence. Ecology 91, 7–14. https://doi.org/10.1890/08-2235.1

Ahrestani, F.S., Saracco, J.F., Sauer, J.R., Pardieck, K.L., Royle, J.A., 2017. An integrated population model for bird monitoring in North America. Ecol Appl 27, 916–924. https://doi.org/10.1002/eap.1493

Besbeas P., Borysiewicz R.S., Morgan B.J., 2009. Completing the Ecological Jigsaw. In: Thomson D.L., Cooch E.G., Conroy M.J. (eds) Modeling Demographic Processes In Marked Populations. Environmental and Ecological Statistics, vol 3. Springer, Boston, MA. https://doi.org/10.1007/978-0-387-78151-8_22

Besbeas, P., Freeman, S.N., Morgan, B.J.T., Catchpole, E.A., 2002. Integrating mark-recapture-recovery and census data to estimate animal abundance and demographic parameters. Biometrics 58, 540–547.

Besbeas, P., Freeman, S.N., Morgan, B.J.T., 2005. The potential of integrated population modelling. Australian & New Zealand Journal of Statistics 47, 35-48. https://doi.org/10.1111/j.1467-842X.2005.00370.x

Bled, F., Belant, J.L., Daele, L.J.V., Svoboda, N., Gustine, D., Hilderbrand, G., Barnes, V.G., n.d. Using multiple data types and integrated population models to improve our knowledge of apex predator population dynamics. Ecology and Evolution 7, 9531–9543. https://doi.org/10.1002/ece3.3469

Bowler, D.E., Nilsen, E.B., Bischof, R., O’Hara, R.B., Yu, T.T., Oo, T., Aung, M., Linnell, J.D.C., 2019. Integrating data from different survey types for population monitoring of an endangered species: the case of the Eld’s deer. Scientific Reports 9, 7766. https://doi.org/10.1038/s41598-019-44075-9

Brooks S.P., King R., Morgan B.J.T., 2004. A Bayesian approach to
combining animal abundance and demographic data. Animal
Biodiversity and Conservation 27, 515–529.

Chandler, R.B., Clark, J.D., 2014. Spatially explicit integrated population models. Methods in Ecology and Evolution 5, 1351–1360. https://doi.org/10.1111/2041-210X.12153

Cruz, J., Windels, S.K., Thogmartin, W.E., Crimmins, S.M., Grim, L.H., Zuckerberg, B., 2018. Managing individual nests promotes population recovery of a top predator. Journal of Applied Ecology 55, 1418–1429.

Farr, M.T., Green, D.S., Holekamp, K.E., Zipkin, E.F., n.d. Integrating distance sampling and presence-only data to estimate species abundance. Ecology n/a, e03204. https://doi.org/10.1002/ecy.3204

Gamelon, M., Baubet, E., Besnard, A., Gaillard, J.-M., Lebreton, J.-D., Touzot, L., Veylit, L., Gimenez, O., 2019.Efficient use of harvest data: An integrated population model for exploited animal populations. bioRxiv 776104. doi: https://doi.org/10.1101/776104

Lee, A.M., Bjørkvoll, E.M., Hansen, B.B., Albon, S.D., Stien, A., Sæther, B.‐E., Engen, S., Veiberg, V., Loe, L.E., Grøtan, V., 2015. An integrated population model for a long‐lived ungulate: more efficient data use with Bayesian methods. Oikos 124, 806-816. https://doi.org/10.1111/oik.01924

McCrea, R.S., Morgan, B.J.T., Gimenez, O., Besbeas, P., Lebreton, J.-D., Bregnballe, T., 2010. Multi-Site Integrated Population Modelling. Journal of Agricultural, Biological and Environmental Statistics 15, 539–561. https://doi.org/10.1007/s13253-010-0027-5

Mormede, S., Parker, S.J., Pinkerton, M.H., 2020. Comparing spatial distribution modelling of fisheries data with single-area or spatially-explicit integrated population models, a case study of toothfish in the Ross Sea region.
Fisheries Research 221, 105381. https://doi.org/10.1016/j.fishres.2019.105381

NIMBLE Development Team. 2020. NIMBLE: MCMC, Particle Filtering, and Programmable Hierarchical Modeling.  doi: 10.5281/zenodo.1211190. R package version 0.10.1, https://cran.r-project.org/package=nimble.

Oppel, S., Hilton, G., Ratcliffe, N., Fenton, C., Daley, J., Gray, G., Vickery, J., Gibbons, D., 2014. Assessing population viability while accounting for demographic and environmental uncertainty. Ecology 95, 1809–1818.

Riecke, T.V., Williams, P.J., Behnke, T.L., Gibson, D., Leach, A.G., Sedinger, B.S., Street, P.A., Sedinger, J.S., 2019. Integrated population models: model assumptions and inference. Methods Ecol Evol 2041–210X.13195. https://doi.org/10.1111/2041-210X.13195

Schaub, M., Abadi, F., 2011. Integrated population models: A novel analysis framework for deeper insights into population dynamics. Journal of Ornithology 152:S227–S237.

Schaub, M., Fletcher, D., 2015. Estimating immigration using a Bayesian integrated population model: choice of 
parametrization and priors. Environ Ecol Stat 22, 535–549. https://doi.org/10.1007/s10651-015-0309-8

Schaub, M., Gimenez, O., Sierro, A., Arlettaz, R., 2007. Use of Integrated Modeling to Enhance Estimates of Population Dynamics Obtained from Limited Data. Conservation Biology 21, 945-955. https://doi.org/10.1111/j.1523-1739.2007.00743.x

Simmonds, E.G., Jarvis, S.G., Henrys, P.A., Isaac, N.J.B., O’Hara, R.B., 2020. Is more data always better? A simulation study of benefits and limitations of integrated distribution models. Ecography 43, 1413–1422. https://doi.org/10.1111/ecog.05146

Sun, C.C., Royle, J.A., Fuller, A.K., 2019. Incorporating citizen science data in spatially explicit integrated population models. Ecology 100, e02777. https://doi.org/10.1002/ecy.2777

Tavecchia, G., Besbeas, P., Coulson, T., Morgan, B.J.T., Clutton‐Brock, T.H., 2009. Estimating Population Size and Hidden Demographic Parameters with State‐Space Modeling. The American Naturalist 173, 722–733. https://doi.org/10.1086/598499

Véran, S., Lebreton, J.D., 2008. The potential of integrated modelling in conservation biology: A case study of the black‐footed albatross (Phoebastria nigripes). Can J Statistics, 36, 85-98. https://doi.org/10.1002/cjs.5550360109

Weegman, M.D., Arnold, T.W., Clark, R.G., Schaub, M., 2020. Partial and complete dependency among data sets has minimal consequence on estimates from integrated population models. Ecological Applications. https://doi.org/10.1002/eap.2258

Woodworth, B., Wheelwright, N., Newman, A., Schaub, M., Norris, D.R., 2017. Winter temperatures limit population growth rate of a migratory songbird. Nat Commun 8, 14812. https://doi.org/10.1038/ncomms14812

Zipkin, E.F., Saunders, S.P., 2018. Synthesizing multiple data types for biological conservation using integrated population models. Biological Conservation 217, 240–250.

 
\newpage

**Figures and Tables**  

```{r plots, eval = F, fig.height = 8.5, fig.width = 7, fig.align = 'center'}

# plots
rmse_plot

```

`r figs("rmse_plot", caption = "Plot of RMSE per scenario.")`


\newpage

`r tbls("rmse_summary", caption = "Table of RMSE by scenario.")`
```{r table, eval = F}

kable(rmse_summary, align = 'c', format.args = list(big.mark = ","))

```



